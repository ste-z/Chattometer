(()=>{function t(){document.getElementById("equiv-bulb-minutes").textContent="--",document.getElementById("equiv-laptop-hours").textContent="--"}function e(){console.log("popup.js: initPopup called"),chrome.storage.local.get(["cumulativeRequests"],(t=>{n(t.cumulativeRequests||{})}));try{chrome.tabs.query({active:!0,currentWindow:!0},(e=>{const n=e[0];if(!n||!n.url)return void t();const o=new URL(n.url),a=`${o.origin}${o.pathname}`;chrome.storage.local.get(["lastImpactDataMap","lastRequestMap"],(e=>{const n=e.lastImpactDataMap||{},o=e.lastRequestMap||{},u=n[a],s=o[a];u&&s?renderPopup(u,s):t()}))}))}catch(e){console.error("Error querying tabs in initPopup:",e),t()}}function n(t){console.log("popup.js: updateCumulative called with",t);let e=0,n=0,o=0,a=1/0;Object.values(t).forEach((t=>{e+=t.energyWh,n+=t.ghgG,t.tokens&&(o+=t.tokens),t.timestamp&&Date.parse(t.timestamp)<a&&(a=Date.parse(t.timestamp))}));const u=isFinite(a)?new Date(a).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"N/A",s=document.getElementById("popup-cum-date");s&&(s.textContent=`Cumulative impacts since ${u}`);const c=document.getElementById("popup-cum-tokens");c&&(c.textContent=o.toString());const l=document.getElementById("popup-cum-energy"),i=document.getElementById("popup-cum-ghg");l&&(l.textContent=e.toFixed(1)+" Wh"),i&&(i.textContent=n.toFixed(1)+" gCO2eq");const m=document.getElementById("equiv-bulb-minutes"),p=document.getElementById("equiv-laptop-hours");if(m){const t=6*e;m.textContent=t.toFixed(0)}if(p){const t=e/35;p.textContent=t.toFixed(1)}}console.log("popup.js loaded"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e(),chrome.storage.onChanged.addListener(((t,e)=>{"local"===e&&(t.cumulativeRequests&&n(t.cumulativeRequests.newValue||{}),(t.lastImpactDataMap||t.lastRequestMap)&&chrome.tabs.query({active:!0,currentWindow:!0},(t=>{const e=t[0];if(!e||!e.url)return;const o=new URL(e.url),a=`${o.origin}${o.pathname}`;chrome.storage.local.get(["lastImpactDataMap","lastRequestMap","cumulativeRequests"],(t=>{const e=t.lastImpactDataMap||{},o=t.lastRequestMap||{},u=t.cumulativeRequests||{};e[a],o[a],n(u)}))})))}))})();